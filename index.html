<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saylist - Sentence to Spotify Playlist</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Ultra deluxe CSS styling with animations, dark mode toggle, tooltips, etc. */
    :root {
      --primary-color: #1db954;
      --background-light: #f5f5f5;
      --background-dark: #121212;
      --text-light: #ffffff;
      --text-dark: #222222;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      display: flex; 
      flex-direction: column;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: var(--background-dark);
      color: var(--text-light);
    }
    header {
      padding: 1.5rem;
      background: var(--primary-color);
      color: #fff;
      text-align: center;
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      user-select: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    main {
      flex-grow: 1;
      max-width: 720px;
      margin: 2rem auto;
      padding: 0 1rem;
      width: 100%;
    }
    #loginBtn, #mainUI {
      text-align: center;
    }
    button {
      cursor: pointer;
      background: var(--primary-color);
      border: none;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      color: white;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(29,185,84,0.6);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    button:hover {
      background: #17c254;
      box-shadow: 0 6px 20px rgba(23,194,84,0.8);
    }
    input[type="text"] {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1.1rem;
      border: 2px solid #ccc;
      border-radius: 40px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
      margin-bottom: 1rem;
    }
    input[type="text"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-color);
    }
    #playlistLink {
      margin-top: 1rem;
      font-weight: 700;
      color: var(--primary-color);
      word-break: break-all;
    }
    #loadingSpinner {
      margin-top: 1rem;
      display: none;
    }
    #errorMsg {
      margin-top: 1rem;
      color: red;
      font-weight: 600;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--primary-color);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 0.5rem;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.9rem;
      user-select: none;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    #darkModeToggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: none;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.5rem 1rem;
      border-radius: 30px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s, color 0.3s;
      z-index: 9999;
    }
    #darkModeToggle:hover {
      background-color: var(--primary-color);
      color: white;
    }
    ul#songsList {
      list-style-type: none;
      padding: 0;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      color: #222;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark ul#songsList {
      background: #222;
      color: #eee;
      border-color: #444;
    }
    ul#songsList li {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    body.dark ul#songsList li {
      border-color: #444;
    }
    ul#songsList li:last-child {
      border-bottom: none;
    }
    ul#songsList li a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }
    ul#songsList li a:hover {
      text-decoration: underline;
      color: #17c254;
    }
  </style>
</head>
<body>
  <header>Saylist</header>
  <button id="darkModeToggle" aria-label="Toggle dark mode">ðŸŒ™ Dark Mode</button>
  <main>
    <!-- Login Button -->
    <div id="loginBtn">
      <button id="btnLogin">Log in with Spotify</button>
    </div>

    <!-- Main UI -->
    <div id="mainUI" style="display:none;">
      <label for="sentenceInput" class="tooltip">
        Enter a sentence to create your playlist
        <span class="tooltiptext">Each word will become a song title in your playlist!</span>
      </label>
      <input
        type="text"
        id="sentenceInput"
        placeholder="Type your sentence here..."
        autocomplete="off"
      />
      <button id="btnCreatePlaylist">Create Playlist</button>

      <div id="loadingSpinner">ðŸŽµ Loading songs...</div>
      <div id="errorMsg"></div>
      <ul id="songsList"></ul>

      <a id="playlistLink" href="#" target="_blank" rel="noopener noreferrer"></a>
    </div>
  </main>

  <script>
    (() => {
      const backendBaseUrl = "https://saylist.onrender.com"; // Your backend URL

      // Elements
      const loginBtn = document.getElementById("loginBtn");
      const btnLogin = document.getElementById("btnLogin");
      const mainUI = document.getElementById("mainUI");
      const btnCreatePlaylist = document.getElementById("btnCreatePlaylist");
      const sentenceInput = document.getElementById("sentenceInput");
      const songsList = document.getElementById("songsList");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const errorMsg = document.getElementById("errorMsg");
      const playlistLink = document.getElementById("playlistLink");
      const darkModeToggle = document.getElementById("darkModeToggle");

      let accessToken = null;
      let userId = null;

      // Dark mode toggle
      function loadDarkMode() {
        const darkMode = localStorage.getItem("darkMode");
        if (darkMode === "enabled") {
          document.body.classList.add("dark");
          darkModeToggle.textContent = "â˜€ï¸ Light Mode";
        } else {
          document.body.classList.remove("dark");
          darkModeToggle.textContent = "ðŸŒ™ Dark Mode";
        }
      }
      darkModeToggle.onclick = () => {
        if (document.body.classList.contains("dark")) {
          localStorage.setItem("darkMode", "disabled");
        } else {
          localStorage.setItem("darkMode", "enabled");
        }
        loadDarkMode();
      };
      loadDarkMode();

      // Parse token from URL hash
      function parseTokenFromHash() {
        const hash = window.location.hash.substring(1);
        if (!hash) return null;
        const params = new URLSearchParams(hash);
        return {
          access_token: params.get("access_token"),
          token_type: params.get("token_type"),
          expires_in: parseInt(params.get("expires_in")),
          refresh_token: params.get("refresh_token"),
          state: params.get("state"),
        };
      }

      // Remove hash from URL without reload
      function clearUrlHash() {
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }

      // Show/hide UI based on login state
      function updateUI() {
        if (accessToken) {
          loginBtn.style.display = "none";
          mainUI.style.display = "block";
        } else {
          loginBtn.style.display = "block";
          mainUI.style.display = "none";
        }
      }

      // Login button click -> go to backend login endpoint
      btnLogin.onclick = () => {
        window.location.href = `${backendBaseUrl}/login`;
      };

      // Spotify API helper to fetch JSON with auth
      async function spotifyFetch(url, options = {}) {
        const resp = await fetch(url, {
          ...options,
          headers: {
            Authorization: `Bearer ${accessToken}`,
            ...options.headers,
          },
        });
        if (resp.status === 401) {
          // Token expired or invalid
          throw new Error("Spotify token expired or unauthorized. Please log in again.");
        }
        return resp.json();
      }

      // Search for exact song title matching the given word
      async function searchExactSong(word) {
        // Use Spotify's search endpoint with `track:${word}` query, type=track
        // But Spotify search is fuzzy, so filter exact title matches manually
        const q = `track:"${word}"`;
        const url = `https://api.spotify.com/v1/search?${new URLSearchParams({
          q,
          type: "track",
          limit: "10",
        })}`;

        const data = await spotifyFetch(url);
        if (!data.tracks || !data.tracks.items.length) return null;

        // Find track with EXACT title match, case-insensitive
        const exact = data.tracks.items.find(
          (track) => track.name.toLowerCase() === word.toLowerCase()
        );

        return exact || null;
      }

      // Get current user's Spotify profile to get userId
      async function fetchUserId() {
        const data = await spotifyFetch("https://api.spotify.com/v1/me");
        return data.id;
      }

      // Create a new playlist for the user
      async function createPlaylist(userId, name, description) {
        const url = `https://api.spotify.com/v1/users/${userId}/playlists`;
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name,
            description,
            public: false,
          }),
        });

        if (!resp.ok) {
          throw new Error("Failed to create playlist");
        }
        return resp.json();
      }

      // Add tracks to playlist by Spotify track URIs
      async function addTracksToPlaylist(playlistId, uris) {
        const url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ uris }),
        });

        if (!resp.ok) {
          throw new Error("Failed to add tracks to playlist");
        }
        return resp.json();
      }

      // Main function to handle playlist creation
      btnCreatePlaylist.onclick = async () => {
        errorMsg.textContent = "";
        songsList.innerHTML = "";
        playlistLink.href = "#";
        playlistLink.textContent = "";
        loadingSpinner.style.display = "block";

        const sentence = sentenceInput.value.trim();
        if (!sentence) {
          errorMsg.textContent = "Please enter a sentence.";
          loadingSpinner.style.display = "none";
          return;
        }

        const words = sentence
          .split(/\s+/)
          .map((w) => w.replace(/[^\w'-]/g, "")) // clean punctuation
          .filter(Boolean);

        if (words.length === 0) {
          errorMsg.textContent = "No valid words found.";
          loadingSpinner.style.display = "none";
          return;
        }

        try {
          if (!userId) userId = await fetchUserId();

          const tracks = [];
          for (const word of words) {
            const track = await searchExactSong(word);
            if (track) {
              tracks.push(track);
              const li = document.createElement("li");
              li.innerHTML = `<a href="${track.external_urls.spotify}" target="_blank" rel="noopener noreferrer" title="Artist(s): ${track.artists
                .map((a) => a.name)
                .join(", ")}">${track.name}</a>`;
              songsList.appendChild(li);
            } else {
              const li = document.createElement("li");
              li.textContent = `"${word}" - No exact match found.`;
              li.style.color = "red";
              songsList.appendChild(li);
            }
          }

          if (tracks.length === 0) {
            errorMsg.textContent = "No songs matched exactly. Try different words!";
            loadingSpinner.style.display = "none";
            return;
          }

          // Create playlist with sentence as name
          const playlistName = `Saylist: ${sentence}`;
          const playlistDescription =
            "A playlist generated by Saylist where each song title matches a word from your sentence.";

          const playlist = await createPlaylist(userId, playlistName, playlistDescription);
          await addTracksToPlaylist(playlist.id, tracks.map((t) => t.uri));

          playlistLink.href = playlist.external_urls.spotify;
          playlistLink.textContent = `ðŸŽ§ Open your playlist: ${playlist.name}`;
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          loadingSpinner.style.display = "none";
        }
      };

      // On page load: parse tokens and update UI
      window.addEventListener("load", () => {
        const tokens = parseTokenFromHash();
        if (tokens && tokens.access_token) {
          accessToken = tokens.access_token;
          clearUrlHash();
        }
        updateUI();
      });
    })();
  </script>
</body>
</html>
